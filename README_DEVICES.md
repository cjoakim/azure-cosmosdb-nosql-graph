# azure-cosmosdb-nosql-graph : devices graph example

In this example the dataset is streaming in nature and created dynamically,
and the related nodes of the graph are also created/updated dynamically.

The implementation code is in **main_devices.py**

## Vertices/Entities in Cosmos DB

- **DeviceSingleton, (D1)**
  - Represents the unique devices as their identifiers evolve
  - did (deviceID) is a uuid
  - attrs: id, label, firstConnection
  - partition key: did (deviceID)
  - dt (documentType): "D1"
- **Device, (D)** 
  - did (deviceID) is a uuid
  - pid (producerID) is a string
  - attrs: did, pid, extId
  - partition key: did (deviceID)
  - dt (documentType): "D"
- **DeviceState (DS)**
  - has current and history
  - since and until timestamps
  - base attrs: did, pid, extId
  - other attrs: os, build, mac, ip (these include identifiers)
  - typical size 500b to 2kb
  - partition key: did (deviceID)
  - dt (documentType): "DS"
- **DeviceAttributes (DA)**
  - These are in two types, strong or weak, and have a value
    - Strong: deviceID, serialNum, computerID, hostname 
    - Weak: osName, ipAddress, macAddress, phoneNum, emailAddr, appUser, buildId
  - attrs: name, value, deviceID
  - partition key: "DA"
  - dt (documentType): "DA"

## Application Flow

- **DeviceState** documents are ingested in an IoT manner

- When a new Device (did/deviceID) arrives:
  - Create both Device and DeviceState 
  - Create the Identifiers as necessary
  
  - check for shared identfiers
  - if same strong identifier, then create 

## Cosmos DB Implementation Notes

id and _ts attributes are system-generated by Cosmos DB

- Use short attribute names to save space
  - For example, did instead of deviceID
  - For example, pk instead of partitionKey
  - For example, pid instead of producerID
  - For example, dt instead of documentType

### Containers

| Name             | Partition Key       |
| ---------------- | ------------------- |
| DeviceSingletons | did (deviceID)      |
| Devices          | did (deviceID)      |
| DeviceState      | did (deviceID)      |
| DeviceAttributes | pk  (synthetic key) |

### Indexing

#### Attribute level indexes

#### Composite indexes

- did/dt

## Repo Implementation Notes
