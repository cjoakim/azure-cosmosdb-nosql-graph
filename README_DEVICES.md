# azure-cosmosdb-nosql-graph : devices graph example

In this example the dataset is streaming in nature and created dynamically,
and the related nodes of the graph are also created/updated dynamically.

The implementation code is in **main_devices.py**

## Vertices/Entities in Cosmos DB

- **DeviceSingleton, (D1)**
  - Represents the unique devices as their identifiers evolve
  - did (deviceID) is a uuid
  - attrs: id, label, firstEventEpoch
  - partition key: did (deviceID)
  - dt (documentType): "D1"

```

```

- **Device, (D)** 
  - did (deviceID) is a uuid
  - pid (producerID) is a string
  - attrs: did, pid, extId
  - partition key: did (deviceID)
  - dt (documentType): "D"

```

```

- **DeviceState (DS)**
  - has current and history
  - since and until timestamps
  - base attrs: did, pid, extId
  - other attrs: os, build, mac, ip (these include identifiers)
  - typical size 500b to 2kb
  - partition key: did (deviceID)
  - dt (documentType): "DS"

```
  {
      "did": "8cf5c21f-8a7d-4aa8-8d5b-5a9be896b3cd",
      "pid": "hunt, combs and mcmahon",
      "extId": "426dd850-32f1-4a6e-88ff-3c100898b457",
      "ser": "90310",
      "cid": "712681",
      "host": "db-92",
      "mac": "ae591184-87ae-4431-b551-e1923d1fdaca",
      "build": 677173,
      "dt": "ds",
      "id": "3e113135-3777-427f-87ff-98bc466e88cb",
      "epoch": 1739733895.2150435,
      "_rid": "8+kcAMsoK1NOAAAAAAAAAA==",
      "_self": "dbs/8+kcAA==/colls/8+kcAMsoK1M=/docs/8+kcAMsoK1NOAAAAAAAAAA==/",
      "_etag": "\"95000fe5-0000-0100-0000-67b23b880000\"",
      "_attachments": "attachments/",
      "_ts": 1739733896
  }

doc size: 546
upsert request_charge: 9.33
```

- **DeviceAttributes (DA)**
  - These are in two types, strong or weak, and have a value
    - Strong: deviceID, serialNum, computerID, hostname 
    - Weak: osName, ipAddress, macAddress, phoneNum, emailAddr, appUser, buildId
  - attrs: name, value, deviceID
  - partition key: "DA"
  - dt (documentType): "DA"

```

```

## Application Flow

- **DeviceState** documents are ingested in an IoT manner

- When a new Device (did/deviceID) arrives:
  - Create both Device and DeviceState 
  - Create the Identifiers as necessary
  
  - check for shared identfiers
  - if same strong identifier, then create 

## Cosmos DB Implementation Notes

id and _ts attributes are system-generated by Cosmos DB

- Use short attribute names to save space
  - For example, did instead of deviceID
  - For example, pk instead of partitionKey
  - For example, pid instead of producerID
  - For example, dt instead of documentType

### Cosmos DB Containers

In "design 1" each of the vertex types are in their own container.

| Name             | Partition Key       |
| ---------------- | ------------------- |
| DeviceSingletons | did (deviceID)      |
| Devices          | did (deviceID)      |
| DeviceState      | did (deviceID)      |
| DeviceAttributes | pk  (synthetic key) |

#### Alternative Design

In "design 2" all vertex types are in in one container.

| Name             | Partition Key                   |
| ---------------- | ------------------------------- |
| DeviceData       | did (deviceID or synthetic key) |

### Indexing

#### Attribute level indexes

#### Composite indexes

- did/dt

## Repo Implementation Notes
